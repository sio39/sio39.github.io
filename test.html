Option Explicit

Dim nextRun As Date

' --- Alt + F8 でこれを実行 ---
Sub StartAutoExport()
    Call AutoExportAndPush
    
    ' 5分間隔でタイマーセット
    nextRun = Now + TimeValue("00:05:00")
    Application.OnTime nextRun, "StartAutoExport"
    Application.StatusBar = "【稼働中】次回実行: " & Format(nextRun, "HH:mm:ss")
End Sub

' --- 自動更新を止めたいときはこれを実行 ---
Sub StopAutoExport()
    On Error Resume Next
    Application.OnTime nextRun, "StartAutoExport", , False
    Application.StatusBar = False
    MsgBox "自動更新を停止しました。"
End Sub

' --- メイン処理 ---
Sub AutoExportAndPush()
    Dim ws As Worksheet
    Dim tempWB As Workbook
    Dim pushFolder As String, pushPath As String
    Dim shellCmd As String
    
    ' ★フォルダパスを環境に合わせて確認してください
    pushFolder = "C:\Users\majis\OneDrive\デスクトップ\sio39.github.io\"
    pushPath = pushFolder & "data_push.csv"

    On Error GoTo ErrorHandler
    
    ' 1. 古いファイルを物理的に削除して更新日時をリセット
    If Dir(pushPath) <> "" Then
        On Error Resume Next
        SetAttr pushPath, vbNormal
        Kill pushPath
        On Error GoTo ErrorHandler
    End If
    DoEvents

    ' 2. データのコピー (A1:J31)
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set tempWB = Workbooks.Add
    ws.Range("A1:J31").Copy
    tempWB.Sheets(1).Range("A1").PasteSpecial xlPasteValues
    
    ' 3. A32セルに「データの実際の更新時刻」を刻印
    tempWB.Sheets(1).Range("A32").Value = "Update:" & Format(Now, "yyyy/mm/dd HH:mm:ss")
    
    ' 4. CSVとして保存 (UTF8)
    Application.DisplayAlerts = False
    tempWB.SaveAs Filename:=pushPath, FileFormat:=xlCSVUTF8
    tempWB.Close False
    Application.DisplayAlerts = True
    
    ' 5. Git Push (履歴エラーを強制回避するリセット付き)
    shellCmd = "cmd /c cd /d """ & pushFolder & """ && " & _
               "git rebase --abort >nul 2>&1 & " & _
               "git fetch origin main && " & _
               "git reset --mixed origin/main && " & _
               "git add . && " & _
               "git commit -m ""AutoUpdate_" & Format(Now, "HHmm_ss") & """ && " & _
               "git push origin main || pause"
    
    Shell shellCmd, vbNormalFocus
    Exit Sub

ErrorHandler:
    Application.DisplayAlerts = True
    MsgBox "エラーが発生しました: " & Err.Description
End Sub