Option Explicit

Dim nextRun As Date

' --- Alt + F8 から実行 ---
Sub StartAutoExport()
    Call AutoExportAndPush
    
    ' 5分間隔
    nextRun = Now + TimeValue("00:05:00")
    Application.OnTime nextRun, "StartAutoExport"
    Application.StatusBar = "【稼働中】次回実行: " & Format(nextRun, "HH:mm:ss")
End Sub

' --- 停止 ---
Sub StopAutoExport()
    On Error Resume Next
    Application.OnTime nextRun, "StartAutoExport", , False
    Application.StatusBar = False
    MsgBox "自動更新を停止しました。"
End Sub

' --- メイン処理 ---
Sub AutoExportAndPush()
    Dim ws As Worksheet
    Dim tempWB As Workbook
    Dim pushFolder As String, pushPath As String
    Dim shellCmd As String
    
    ' フォルダパスの確認
    pushFolder = "C:\Users\majis\OneDrive\デスクトップ\sio39.github.io\"
    pushPath = pushFolder & "data_push.csv"

    On Error GoTo ErrorHandler
    
    ' ファイルの初期化（更新日時を確実に新しくする）
    If Dir(pushPath) <> "" Then
        On Error Resume Next
        SetAttr pushPath, vbNormal
        Kill pushPath
        On Error GoTo ErrorHandler
    End If
    DoEvents

    ' データコピー
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set tempWB = Workbooks.Add
    ws.Range("A1:J31").Copy
    tempWB.Sheets(1).Range("A1").PasteSpecial xlPasteValues
    
    ' CSV内に更新時刻を書き込む
    tempWB.Sheets(1).Range("A32").Value = "Update:" & Format(Now, "yyyy/mm/dd HH:mm:ss")
    
    ' 保存
    Application.DisplayAlerts = False
    tempWB.SaveAs Filename:=pushPath, FileFormat:=xlCSVUTF8
    tempWB.Close False
    Application.DisplayAlerts = True
    
    ' Git Push (履歴リセット機能付き)
    shellCmd = "cmd /c cd /d """ & pushFolder & """ && " & _
               "git rebase --abort >nul 2>&1 & " & _
               "git fetch origin main && " & _
               "git reset --mixed origin/main && " & _
               "git add . && " & _
               "git commit -m ""AutoUpdate_" & Format(Now, "HHmm_ss") & """ && " & _
               "git push origin main || pause"
    
    Shell shellCmd, vbNormalFocus
    Exit Sub

ErrorHandler:
    Application.DisplayAlerts = True
    MsgBox "エラー: " & Err.Description
End Sub